(function(e,t){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","base","simple-oauth"],t):e.Backbone.OAuth=t(e.$,e._,e.Backbone,Base,SimpleOAuth)})(this,function(e,t,s,r,i){function n(){var e=URI.parseUri(location.href);return u(e.query)}function a(){var e,s=URI.parseUri(location.href);return e=t.chain(URI.parseQuery(s.query)||{}).pairs().filter(function(e){return-1==e[0].indexOf("oauth_")}).object().value(),s.query=URI.queryString(e),s.build()}function u(e){return t.chain(URI.parseQuery(e)||{}).pairs().map(function(e){return[e[0].replace(/^[x]?oauth_/,""),e[1]]}).object().value()}var o=function(){function s(e,s){var r=URI.parseUri(s);if(r.query&&(r.query=URI.queryString(URI.parseQuery(r.query.replace(/\+/g," "))),s=r.build()),!e)return s;var i=e.split("/").reverse(),n=s.split("/"),a=[],u=0;return i=t.compact(t.filter(i,function(e){return e.length>0?e:null})),n=t.compact(t.filter(n,function(e){return e.length>0?e:null})),t.each(i,function(e){e!=n[u]?a.unshift(e):u++}),a.push.apply(a,n),"/"+a.join("/")}function r(e){return t.chain(n).filter(function(t,r){var i=s(t.basepath,e);return i.indexOf("/"+r)>-1}).first().value()}function i(e,r,i){var n=location.protocol+"//"+location.host,a={type:r.type,path:n,url:s(i.basepath,r.url),data:r.contentType.indexOf("application/x-www-form-urlencoded")>-1?URI.parseQuery(r.data||""):null,headers:{}};i.build.apply(i,[a]),r.url=a.url,t.each(a.headers,function(t,s){e.setRequestHeader(s,t)})}var n={};e.ajaxSetup({beforeSend:function(e,t){var s=r(t.url);s&&i(e,t,s)}}),e(document).ajaxError(function(e,t,s){if(200!=t.status){var i=r(s.url);i&&i.rescue(t.status)}});var a=function(){};return a.prototype.register=function(e){n[e.namespace]=e},a.prototype.unregister=function(e){delete n[e.namespace]},new a}();return s.OAuth=r.extend([s.Events],{constructor:function(e){var e=e||{};this.initialize(e)},basepath:null,namespace:null,keys:null,urls:null,scheme:null,site:null,rewrite:null,errors:null,adapter:null,reset:function(e){this.state=1,this.keys.token=this.keys.token_secret="",this.persist(),this.prepare(),e||this.trigger("oauth:reset")},authorized:function(){return 4==this.state&&this.keys.token.length>0&&this.keys.token_secret.length>0},authorizing:function(){return 1!=this.state&&!this.authorized()},authorize:function(){switch(this.state){case 1:this.request_token();break;case 2:this.confirm();break;case 3:this.access_token();break;case 4:this.complete()}},state:1,initialize:function(e){this.keys=e.keys,this.urls=e.urls||{},this.namespace=e.namespace,this.basepath=e.basepath,this.errors=e.errors||[],this.scheme=e.scheme||"header",this.rewrite=e.rewrite||"/"+this.namespace,this.site=e.site,this.adapter=e.adapter||new s.OAuth.Adapter,this.keys&&this.namespace&&(this.restore(),this.setup(),this.prepare())},setup:function(){o.register(this)},reload:function(){this.keys&&this.namespace&&(this.restore(),this.prepare(),this.trigger("oauth:ready",this.adapter.data()))},request_token:function(){var t=this;this.prepare(),e.ajax({url:this.urls.request,type:"POST",processData:!1}).done(function(e){t.update(u(e)),t.state++,t.persist(),t.authorize()}).fail(function(e){console.log("request_token failed "+e.status),t.rescue(e.status)})},confirm:function(){var e={url:this.urls.authorize};this.prepare(),this.build(e),this.state++,this.persist(),location.href=e.url},access_token:function(){var t=this;this.prepare(),e.ajax({url:this.urls.access,type:"POST",processData:!1}).done(function(e){t.update(u(e)),t.state++,t.persist(),t.authorize()}).fail(function(e){console.log("access_token failed "+e.status),t.rescue(e.status)})},complete:function(){var e;(e=a())!=location.href&&(location.href=e),this.prepare(),this.trigger("oauth:ready",this.adapter.data())},renew_token:function(){var t=this;return this.urls.renew?(this.prepare(),e.ajax({url:this.urls.renew,type:"POST",processData:!1}).done(function(e){t.update(u(e)),t.persist(),t.authorize()}).fail(function(s){e.inArray(s.status,t.errors)&&console.log("failed renew!"),t.reset()}),void 0):(console.log("no renew!"),this.reset(),void 0)},rescue:function(e){console.log("rescuing "+e),t.contains(this.errors,e)?this.authorized()?this.renew_token():(console.log("rescue - authorizing!"),this.reset()):this.authorizing()&&this.trigger("oauth:failure")},restore:function(){var e=["token","token_secret","state"].concat(this.adapter.persistent_data),s=Array(e.length),r=sessionStorage[this.keys.consumer_key]||s.join("&"),i=t.map(r.split("&"),function(e){return e.length>0?e:null}),n=t.object(e,i);this.state=+n.state||1,t.extend(this.keys,t.pick(n,"token","token_secret")),this.adapter.data(t.omit(n,"token","token_secret","state"))},persist:function(){var e=t.flatten([t.values(t.pick(this.keys,"token","token_secret")),this.state,t.values(this.adapter.data())]);sessionStorage[this.keys.consumer_key]=t.map(e,function(e){return e}).join("&")},prepare:function(){var e=t.clone(this.keys);this.adapter.prepare(this.state,e)},update:function(e){t.extend(this.keys,t.pick(e,"consumer_key","consumer_secret","token","token_secret")),this.adapter.update(this.state,e)},build:function(e){var t,s=this.rewrite;e.auth_header={},e.sign=!1,this.adapter.build(this.state,e),e.sign&&(t=new i.Header(e.type,(this.site||e.path)+e.url.replace(s,""),e.data,e.auth_header),"header"==this.scheme?e.headers.Authorization=t.build(this.scheme):"query"==this.placement&&(e.url+=(e.url.indexOf("?")>-1?"&":"?")+t.build(this.scheme)))}}),s.OAuth.Adapters={},s.OAuth.Adapter=r.extend({persistent_data:null,store:null,constructor:function(e){var e=e||{};this.initialize(e)},initialize:function(e){this.persistent_data=e.saved_params||[]},data:function(e){return e?(this.store=t.extend(this.store||{},e),void 0):t.pick.apply(this,t.flatten([this.store,this.persistent_data]))},prepare:function(e,s){this.store=t.extend(this.store||{},s)},update:function(e,s){this.store=t.extend(this.store||{},t.pick.apply(this,t.flatten([s,this.persistent_data])))},build:function(e,s){s.sign=!0,s.auth_header=t.pick(this.store,"consumer_key","consumer_secret")}}),s.OAuth.Adapters.v1revA=s.OAuth.Adapter.extend({prepare:function(e,s){1==e&&(s=t.extend(s,{callback:a()})),3==e&&(s=t.extend(s,n())),this._super(e,s)},build:function(e,s){if(2==e)s.url=s.url+"?oauth_token="+this.store.token;else switch(s.sign=!0,e){case 1:s.auth_header=t.pick(this.store,"consumer_key","consumer_secret","callback");break;case 3:s.auth_header=t.pick(this.store,"consumer_key","consumer_secret","token","token_secret","verifier");break;case 4:s.auth_header=t.pick(this.store,"consumer_key","consumer_secret","token","token_secret")}}}),s.OAuth});