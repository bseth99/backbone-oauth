(function(e,t){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","base"],t):e.Backbone.OAuth=t(e.$,e._,e.Backbone,Base)})(this,function(e,t,s,r){function i(){var e=URI.parseUri(location.href);return a(e.query)}function n(){var e,s=URI.parseUri(location.href);return e=t.chain(URI.parseQuery(s.query)||{}).pairs().filter(function(e){return-1==e[0].indexOf("oauth_")}).object().value(),s.query=URI.queryString(e),s.build()}function a(e){return t.chain(URI.parseQuery(e)||{}).pairs().map(function(e){return[e[0].replace(/^[x]?oauth_/,""),e[1]]}).object().value()}var o=function(){function s(e){return t.chain(i).filter(function(t,s){return e.indexOf("/"+s)>-1}).first().value()}function r(e,s,r){var i=location.protocol+"//"+location.host,n={type:s.type,path:i,url:s.url,data:s.contentType.indexOf("application/x-www-form-urlencoded")>-1?URI.parseQuery(s.data||""):null,headers:{}};r.build.apply(r,[n]),s.url=n.url,t.each(n.headers,function(t,s){e.setRequestHeader(s,t)})}var i={};e.ajaxSetup({beforeSend:function(e,t){var i=s(t.url);i&&r(e,t,i)}}),e(document).ajaxError(function(e,t,r){if(200!=t.status){var i=s(r.url);i&&i.rescue(t.status)}});var n=function(){};return n.prototype.register=function(e){i[e.namespace]=e},n.prototype.unregister=function(e){delete i[e.namespace]},new n}();return s.OAuth=r.extend([s.Events],{constructor:function(e){var e=e||{};this.initialize(e)},namespace:null,keys:null,urls:null,scheme:null,site:null,rewrite:null,errors:null,adapter:null,reset:function(){this.state=1,this.keys.token=this.keys.token_secret="",this.persist(),this.prepare(),this.trigger("oauth:reset")},authorized:function(){return 4==this.state&&this.keys.token.length>0&&this.keys.token_secret.length>0},authorizing:function(){return 1!=this.state&&!this.authorized()},authorize:function(){switch(this.state){case 1:this.request_token();break;case 2:this.confirm();break;case 3:this.access_token();break;case 4:this.complete()}},state:1,initialize:function(e){this.keys=e.keys,this.urls=e.urls||{},this.namespace=e.namespace,this.errors=e.errors||[],this.scheme=e.scheme||"header",this.rewrite=e.rewrite||"/"+this.namespace,this.site=e.site,this.adapter=e.adapter||new s.OAuth.Adapter,this.keys&&this.namespace&&(this.restore(),this.setup(),this.prepare())},setup:function(){o.register(this)},reload:function(){this.keys&&this.namespace&&(this.restore(),this.prepare())},request_token:function(){var t=this;this.prepare(),e.ajax({url:this.urls.request,type:"POST",processData:!1}).done(function(e){t.update(a(e)),t.state++,t.persist(),t.authorize()}).fail(function(e){console.log("request_token failed "+e.status),t.rescue(e.status)})},confirm:function(){var e={url:this.urls.authorize};this.prepare(),this.build(e),this.state++,this.persist(),location.href=e.url},access_token:function(){var t=this;this.prepare(),e.ajax({url:this.urls.access,type:"POST",processData:!1}).done(function(e){t.update(a(e)),t.state++,t.persist(),t.authorize()}).fail(function(e){console.log("access_token failed "+e.status),t.rescue(e.status)})},complete:function(){var e;(e=n())!=location.href&&(location.href=e),this.prepare(),this.trigger("oauth:ready",this.adapter.data())},renew_token:function(){var t=this;return this.urls.renew?(this.prepare(),e.ajax({url:this.urls.renew,type:"POST",processData:!1}).done(function(e){t.update(a(e)),t.persist(),t.authorize()}).fail(function(s){e.inArray(s.status,t.errors)&&console.log("failed renew!"),t.reset()}),void 0):(console.log("no renew!"),this.reset(),void 0)},rescue:function(t){console.log("rescuing "+t),e.inArray(t,this.errors)?this.authorized()?this.renew_token():(console.log("rescue - authorizing!"),this.reset()):this.trigger("oauth:failure")},restore:function(){var e=["token","token_secret","state"].concat(this.adapter.persistent_data),s=Array(e.length),r=sessionStorage[this.keys.consumer_key]||s.join("&"),i=t.map(r.split("&"),function(e){return e.length>0?e:null}),n=t.object(e,i);this.state=+n.state||1,t.extend(this.keys,t.pick(n,"token","token_secret")),this.adapter.data(t.omit(n,"token","token_secret","state"))},persist:function(){var e=t.flatten([t.values(t.pick(this.keys,"token","token_secret")),this.state,t.values(this.adapter.data())]);sessionStorage[this.keys.consumer_key]=t.map(e,function(e){return e}).join("&")},prepare:function(){var e=t.clone(this.keys);this.adapter.prepare(this.state,e)},update:function(e){t.extend(this.keys,t.pick(e,"consumer_key","consumer_secret","token","token_secret")),this.adapter.update(this.state,e)},build:function(e){var t,s=this.rewrite;e.auth_header={},e.sign=!1,this.adapter.build(this.state,e),e.sign&&(t=new SimpleOAuth.Header(e.type,(this.site||e.path)+e.url.replace(s,""),e.data,e.auth_header),"header"==this.scheme?e.headers.Authorization=t.build(this.scheme):"query"==this.placement&&(e.url+=(e.url.indexOf("?")>-1?"&":"?")+t.build(this.scheme)))}}),s.OAuth.Adapters={},s.OAuth.Adapter=r.extend({persistent_data:null,store:null,constructor:function(e){var e=e||{};this.initialize(e)},initialize:function(e){this.persistent_data=e.saved_params||[]},data:function(e){return e?(this.store=t.extend(this.store||{},e),void 0):t.pick.apply(this,t.flatten([this.store,this.persistent_data]))},prepare:function(e,s){this.store=t.extend(this.store||{},s)},update:function(e,s){this.store=t.extend(this.store||{},t.pick.apply(this,t.flatten([s,this.persistent_data])))},build:function(e,s){s.sign=!0,s.auth_header=t.pick(this.store,"consumer_key","consumer_secret")}}),s.OAuth.Adapters.v1revA=s.OAuth.Adapter.extend({prepare:function(e,s){1==e&&(s=t.extend(s,{callback:n()})),3==e&&(s=t.extend(s,i())),this._super(e,s)},build:function(e,s){if(2==e)s.url=s.url+"?oauth_token="+this.store.token;else switch(s.sign=!0,e){case 1:s.auth_header=t.pick(this.store,"consumer_key","consumer_secret","callback");break;case 3:s.auth_header=t.pick(this.store,"consumer_key","consumer_secret","token","token_secret","verifier");break;case 4:s.auth_header=t.pick(this.store,"consumer_key","consumer_secret","token","token_secret")}}}),s.OAuth});